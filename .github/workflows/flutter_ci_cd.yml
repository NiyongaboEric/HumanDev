name: Flutter CI-CD

on:
  push:
    branches: [ "main","dev" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    outputs:
      appVersion: ${{ steps.get-app-version.outputs.appVersion }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Flutter dependencies
        uses: actions/cache@v2
        with:
          path: |
            ~/.pub-cache
            ~/flutter/.pub-cache
            ~/android/.gradle/caches
            ~/android/.gradle/wrapper
          key: ${{ runner.os }}-pub-gradle-${{ hashFiles('**/*.yaml') }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          # flutter-version: '3.16.x'
          channel: "stable"

      - name: Install dependencies
        run: dart pub get

      # Uncomment this step to verify the use of 'dart format' on each commit.
      # - name: Verify formatting
      #   run: dart format --output=none --set-exit-if-changed .

      # Consider passing '--fatal-infos' for slightly stricter analysis.
      # - name: Analyze project source
      #   run: dart analyze

      # Your project will need to have tests in test/ and a dependency on
      # package:test for this step to succeed. Note that Flutter projects will
      # want to change this to 'flutter test'.
      # - name: Run tests
      #   run: dart test

      - name: Generate constants file
        run: |
          echo "class ApiConstants {" >> lib/data/constants/constants.dart
          if [[ $GITHUB_REF == refs/heads/main ]]; then
            echo MAIN BRANCH
            echo "static const String baseAuthUrl = 'https://dev.auth.seymo.ai';" >> lib/data/constants/constants.dart
          else
            echo DEV BRANCH
            echo "static const String baseAuthUrl = 'https://dev.auth.seymo.ai';" >> lib/data/constants/constants.dart
          fi
          echo "}" >> lib/data/constants/constants.dart

      - name: Get app version
        id: get-app-version
        run: |
          APP_VERSION=$(grep -oP 'version: \K(.+)' pubspec.yaml)
          echo "App Version: $APP_VERSION"
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
          echo "appVersion=$APP_VERSION" >> $GITHUB_OUTPUT
#          echo "::set-output name=app_version::$APP_VERSION"

      - name: Build APK
        run: flutter build apk --release

      - name: Rename APK
        run: mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/seymo_v$APP_VERSION.apk

#      - name: Check files in folder
#        run: |
#          ls build/app/outputs/flutter-apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
#          name: app-release
#          path: build/app/outputs/flutter-apk/app-release.apk
          name: seymo_v$APP_VERSION
          path: build/app/outputs/flutter-apk/seymo_v${{ env.APP_VERSION }}.apk

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download APKs
        uses: actions/download-artifact@v4
        env:
          appVersion: ${{ needs.build.outputs.appVersion }}
        with:
#          name: app-release
          name: seymo_v${{ env.appVersion }}
          path: build/app/outputs/flutter-apk/

      - name: Create Release and Upload APK to Release
        id: create_and_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_REPOSITORY: my_gh_org/my_gh_repo
          appVersion: ${{ needs.build.outputs.appVersion }}
        with:
#          files: build/app/outputs/flutter-apk/app-release.apk
          files: build/app/outputs/flutter-apk/seymo_v${{ env.appVersion }}.apk
          token: ${{ secrets.GITHUB_TOKEN }}
          name: Release v${{ env.appVersion }}
          tag_name: v${{ env.appVersion }}
          draft: false
          prerelease: false
